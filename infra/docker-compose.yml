# version: "3.9"

# services:
#   redis:
#     image: redis:7
#     restart: unless-stopped
#     ports:
#       - "6379:6379"

#   backend:
#     build:
#       context: ../backend
#       dockerfile: Dockerfile
#     container_name: floorplan-backend
#     restart: unless-stopped
#     ports:
#       - "8000:8000"
#     environment:
#       - REDIS_URL=redis://redis:6379/0
#     volumes:
#       - ../backend/app:/app/app
#       - ../data:/data
#     depends_on:
#       - redis

#   worker:
#     build:
#       context: ../worker
#       dockerfile: Dockerfile
#     container_name: floorplan-worker
#     restart: unless-stopped
#     environment:
#       - REDIS_URL=redis://redis:6379/0
#       - SD_MODEL_ID=runwayml/stable-diffusion-v1-5
#       - LORA_PATH=/models/lora
#       - OUTPUT_DIR=/data/generated
#     volumes:
#       - ../models:/models
#       - ../data:/data
#     deploy:
#       resources:
#         reservations:
#           devices:
#             - capabilities: [gpu]
#     depends_on:
#       - redis

#   frontend:
#     build:
#       context: ../frontend
#       dockerfile: Dockerfile
#     container_name: floorplan-frontend
#     restart: unless-stopped
#     ports:
#       - "3000:3000"
#     environment:
#       - NEXT_PUBLIC_API_URL=http://localhost:8000
#     depends_on:
#       - backend

version: "3.9"

services:
  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: floorplan-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ../data:/data
    depends_on:
      - redis

  worker:
    build:
      context: ../worker
      dockerfile: Dockerfile
    container_name: floorplan-worker
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - SD_MODEL_ID=runwayml/stable-diffusion-v1-5
      - LORA_PATH=/models/lora
      - OUTPUT_DIR=/data/generated
      # - NVIDIA_VISIBLE_DEVICES=all
      # - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ../models:/models
      - ../data:/data
      - ../hf_cache:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
    depends_on:
      - redis

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: floorplan-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
      # Use the service name 'redis' for internal docker networking
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - backend
